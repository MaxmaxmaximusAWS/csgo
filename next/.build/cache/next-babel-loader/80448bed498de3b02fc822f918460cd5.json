{"ast":null,"code":"import _defineProperty from\"@babel/runtime/helpers/esm/defineProperty\";import _regeneratorRuntime from\"@babel/runtime/regenerator\";import _asyncToGenerator from\"@babel/runtime/helpers/esm/asyncToGenerator\";import _extends from\"@babel/runtime/helpers/esm/extends\";import _objectWithoutProperties from\"@babel/runtime/helpers/esm/objectWithoutProperties\";var _jsxFileName=\"/app/services/next-js/lib/withApollo.js\";import React from\"react\";var __jsx=React.createElement;function ownKeys(object,enumerableOnly){var keys=Object.keys(object);if(Object.getOwnPropertySymbols){var symbols=Object.getOwnPropertySymbols(object);if(enumerableOnly)symbols=symbols.filter(function(sym){return Object.getOwnPropertyDescriptor(object,sym).enumerable;});keys.push.apply(keys,symbols);}return keys;}function _objectSpread(target){for(var i=1;i<arguments.length;i++){var source=arguments[i]!=null?arguments[i]:{};if(i%2){ownKeys(Object(source),true).forEach(function(key){_defineProperty(target,key,source[key]);});}else if(Object.getOwnPropertyDescriptors){Object.defineProperties(target,Object.getOwnPropertyDescriptors(source));}else{ownKeys(Object(source)).forEach(function(key){Object.defineProperty(target,key,Object.getOwnPropertyDescriptor(source,key));});}}return target;}import NextApp from\"next/app\";import{ApolloProvider}from'@apollo/react-hooks';import{ApolloClient}from\"apollo-client\";import{InMemoryCache}from\"apollo-cache-inmemory\";import{HttpLink}from\"apollo-link-http\";import{WebSocketLink}from\"apollo-link-ws\";import{ApolloLink,split}from\"apollo-link\";import{getMainDefinition}from\"apollo-utilities\";import Head from'next/head';export default function withApollo(App,options){function AppWithApollo(_ref){var client=_ref.client,clientState=_ref.clientState,ctx=_ref.ctx,props=_objectWithoutProperties(_ref,[\"client\",\"clientState\",\"ctx\"]);if(!client){client=initApolloClient(options,ctx,clientState);}return __jsx(ApolloProvider,{client:client,__self:this,__source:{fileName:_jsxFileName,lineNumber:20,columnNumber:12}},__jsx(App,_extends({},props,{__self:this,__source:{fileName:_jsxFileName,lineNumber:21,columnNumber:7}})));}AppWithApollo.getInitialProps=/*#__PURE__*/function(){var _ref3=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee(_ref2){var AppTree,ctx,pageProps,clientState,client,_require,getDataFromTree;return _regeneratorRuntime.wrap(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:AppTree=_ref2.AppTree,ctx=_ref2.ctx;pageProps={};clientState={};client=null;if(true){_context.next=21;break;}if(!(ctx.res&&ctx.res.finished)){_context.next=7;break;}return _context.abrupt(\"return\",{pageProps:pageProps});case 7:_require=require('@apollo/react-ssr'),getDataFromTree=_require.getDataFromTree;client=initApolloClient(options,ctx);_context.prev=9;_context.next=12;return getDataFromTree(__jsx(AppTree,_extends({pageProps:pageProps,client:client,ctx:ctx},{__self:this,__source:{fileName:_jsxFileName,lineNumber:41,columnNumber:31}})));case 12:clientState=client.cache.extract();_context.next=18;break;case 15:_context.prev=15;_context.t0=_context[\"catch\"](9);console.error(_context.t0);case 18:_context.prev=18;Head.rewind();return _context.finish(18);case 21:return _context.abrupt(\"return\",{pageProps:pageProps,clientState:clientState,client:client});case 22:case\"end\":return _context.stop();}}},_callee,this,[[9,15,18,21]]);}));return function(_x){return _ref3.apply(this,arguments);};}();// AppWithApollo.getInitialProps = NextApp.getInitialProps\n// AppWithApollo.origGetInitialProps = NextApp.origGetInitialProps\nreturn AppWithApollo;}var browserApolloClientCache=null;function initApolloClient(options,ctx){var clientState=arguments.length>2&&arguments[2]!==undefined?arguments[2]:null;if(!true){return createApolloClient(options,ctx,clientState);}if(!browserApolloClientCache){browserApolloClientCache=createApolloClient(options,ctx,clientState);}return browserApolloClientCache;}function createApolloClient(options,ctx){var clientState=arguments.length>2&&arguments[2]!==undefined?arguments[2]:null;var cache=new InMemoryCache();var link=createLink(options,ctx);var client=new ApolloClient({ssrMode:!true,cache:cache.restore(clientState),link:link});client.toJSON=function(){return null;};return client;}function createLink(options,ctx){if(!true){var _fetch=require('isomorphic-fetch');var cookie=ctx.req.headers.cookie||'';return new HttpLink({uri:process.env.LOCAL_GRAPHQL_ENDPOINT,fetch:function fetch(url,options){return _fetch(url,_objectSpread(_objectSpread({},options),{},{compress:false,headers:{\"Cookie\":cookie}}));}});}return createBrowserLink();}function createBrowserLink(){var httpLink=new HttpLink({credentials:'include',uri:\"/graphql\"});var wsLink=new WebSocketLink({uri:\"ws://\".concat(location.host,\"/graphql\"),options:{reconnect:true}});var terminatingLink=split(function(_ref4){var query=_ref4.query;var _getMainDefinition=getMainDefinition(query),kind=_getMainDefinition.kind,operation=_getMainDefinition.operation;return kind==='OperationDefinition'&&operation==='subscription';},wsLink,httpLink);return ApolloLink.from([terminatingLink]);}","map":{"version":3,"sources":["/app/services/next-js/lib/withApollo.js"],"names":["NextApp","ApolloProvider","ApolloClient","InMemoryCache","HttpLink","WebSocketLink","ApolloLink","split","getMainDefinition","Head","withApollo","App","options","AppWithApollo","client","clientState","ctx","props","initApolloClient","getInitialProps","AppTree","pageProps","res","finished","require","getDataFromTree","cache","extract","console","error","rewind","browserApolloClientCache","createApolloClient","link","createLink","ssrMode","restore","toJSON","fetch","cookie","req","headers","uri","process","env","LOCAL_GRAPHQL_ENDPOINT","url","compress","createBrowserLink","httpLink","credentials","wsLink","location","host","reconnect","terminatingLink","query","kind","operation","from"],"mappings":"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","sourcesContent":["import NextApp from \"next/app\"\r\nimport { ApolloProvider } from '@apollo/react-hooks'\r\nimport { ApolloClient } from \"apollo-client\";\r\nimport { InMemoryCache } from \"apollo-cache-inmemory\";\r\nimport { HttpLink } from \"apollo-link-http\";\r\nimport { WebSocketLink } from \"apollo-link-ws\";\r\nimport { ApolloLink, split } from \"apollo-link\";\r\nimport { getMainDefinition } from \"apollo-utilities\";\r\nimport Head from 'next/head'\r\n\r\n\r\nexport default function withApollo(App, options) {\r\n\r\n  function AppWithApollo({client, clientState, ctx, ...props}) {\r\n\r\n    if (!client) {\r\n      client = initApolloClient(options, ctx, clientState)\r\n    }\r\n\r\n    return <ApolloProvider client={ client }>\r\n      <App { ...props }/>\r\n    </ApolloProvider>\r\n  }\r\n\r\n\r\n  AppWithApollo.getInitialProps = async function ({AppTree, ctx}) {\r\n    let pageProps = {}\r\n    let clientState = {}\r\n    let client = null\r\n\r\n    if (!process.browser) {\r\n      // When redirecting, the response is finished.\r\n      if (ctx.res && ctx.res.finished) {\r\n        return {pageProps}\r\n      }\r\n\r\n      const {getDataFromTree} = require('@apollo/react-ssr')\r\n      client = initApolloClient(options, ctx)\r\n\r\n      try {\r\n        await getDataFromTree(<AppTree  { ...{pageProps, client, ctx} }/>)\r\n        clientState = client.cache.extract()\r\n      } catch (error) {\r\n        console.error(error)\r\n      } finally {\r\n        Head.rewind()\r\n      }\r\n\r\n    }\r\n\r\n    return {pageProps, clientState, client}\r\n  }\r\n\r\n\r\n  // AppWithApollo.getInitialProps = NextApp.getInitialProps\r\n  // AppWithApollo.origGetInitialProps = NextApp.origGetInitialProps\r\n\r\n  return AppWithApollo\r\n\r\n}\r\n\r\n\r\nlet browserApolloClientCache = null\r\n\r\n\r\nfunction initApolloClient(options, ctx, clientState = null) {\r\n  if (!process.browser) {\r\n    return createApolloClient(options, ctx, clientState)\r\n  }\r\n\r\n  if (!browserApolloClientCache) {\r\n    browserApolloClientCache = createApolloClient(options, ctx, clientState)\r\n  }\r\n  return browserApolloClientCache\r\n}\r\n\r\n\r\nfunction createApolloClient(options, ctx, clientState = null) {\r\n  const cache = new InMemoryCache()\r\n  const link = createLink(options, ctx)\r\n\r\n  const client = new ApolloClient({\r\n    ssrMode: !process.browser,\r\n    cache: cache.restore(clientState),\r\n    link\r\n  })\r\n\r\n  client.toJSON = () => null\r\n  return client\r\n}\r\n\r\n\r\nfunction createLink(options, ctx) {\r\n\r\n  if (!process.browser) {\r\n    const fetch = require('isomorphic-fetch')\r\n    const cookie = ctx.req.headers.cookie || ''\r\n\r\n    return new HttpLink({\r\n      uri: process.env.LOCAL_GRAPHQL_ENDPOINT,\r\n      fetch: (url, options) => {\r\n        return fetch(url, {\r\n          ...options,\r\n          compress: false,\r\n          headers: {\"Cookie\": cookie}\r\n        })\r\n      }\r\n    })\r\n  }\r\n\r\n  return createBrowserLink()\r\n}\r\n\r\n\r\nfunction createBrowserLink() {\r\n  const httpLink = new HttpLink({\r\n    credentials: 'include',\r\n    uri: `/graphql`,\r\n  })\r\n\r\n  const wsLink = new WebSocketLink({\r\n    uri: `ws://${location.host}/graphql`,\r\n    options: {\r\n      reconnect: true,\r\n    },\r\n  })\r\n\r\n  const terminatingLink = split(({query}) => {\r\n    const {kind, operation} = getMainDefinition(query);\r\n    return (kind === 'OperationDefinition' && operation === 'subscription');\r\n  }, wsLink, httpLink)\r\n\r\n  return ApolloLink.from([terminatingLink])\r\n}\r\n\r\n\r\n"]},"metadata":{},"sourceType":"module"}