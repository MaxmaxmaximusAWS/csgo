{"ast":null,"code":"var _jsxFileName=\"/app/services/next-js/lib/withApollo.js\";import React from\"react\";var __jsx=React.createElement;function _extends(){_extends=Object.assign||function(target){for(var i=1;i<arguments.length;i++){var source=arguments[i];for(var key in source){if(Object.prototype.hasOwnProperty.call(source,key)){target[key]=source[key];}}}return target;};return _extends.apply(this,arguments);}function _objectWithoutProperties(source,excluded){if(source==null)return{};var target=_objectWithoutPropertiesLoose(source,excluded);var key,i;if(Object.getOwnPropertySymbols){var sourceSymbolKeys=Object.getOwnPropertySymbols(source);for(i=0;i<sourceSymbolKeys.length;i++){key=sourceSymbolKeys[i];if(excluded.indexOf(key)>=0)continue;if(!Object.prototype.propertyIsEnumerable.call(source,key))continue;target[key]=source[key];}}return target;}function _objectWithoutPropertiesLoose(source,excluded){if(source==null)return{};var target={};var sourceKeys=Object.keys(source);var key,i;for(i=0;i<sourceKeys.length;i++){key=sourceKeys[i];if(excluded.indexOf(key)>=0)continue;target[key]=source[key];}return target;}import NextApp from\"next/app\";import{ApolloProvider}from'@apollo/react-hooks';import{ApolloClient}from\"apollo-client\";import{InMemoryCache}from\"apollo-cache-inmemory\";import{HttpLink}from\"apollo-link-http\";import{WebSocketLink}from\"apollo-link-ws\";import{ApolloLink,split}from\"apollo-link\";import{getMainDefinition}from\"apollo-utilities\";import Head from'next/head';export default function withApollo(App,options){function AppWithApollo(_ref){let{client,clientState,ctx}=_ref,props=_objectWithoutProperties(_ref,[\"client\",\"clientState\",\"ctx\"]);if(!client){client=initApolloClient(options,ctx,clientState);}return __jsx(ApolloProvider,{client:client,__self:this,__source:{fileName:_jsxFileName,lineNumber:20,columnNumber:12}},__jsx(App,_extends({},props,{__self:this,__source:{fileName:_jsxFileName,lineNumber:21,columnNumber:7}})));}AppWithApollo.getInitialProps=async function({AppTree,ctx}){let pageProps={};let clientState={};let client=null;if(!false){// When redirecting, the response is finished.\nif(ctx.res&&ctx.res.finished){return{pageProps};}const{getDataFromTree}=require('@apollo/react-ssr');client=initApolloClient(options,ctx);try{await getDataFromTree(__jsx(AppTree,_extends({pageProps,client,ctx},{__self:this,__source:{fileName:_jsxFileName,lineNumber:41,columnNumber:31}})));clientState=client.cache.extract();}catch(error){console.error(error);}finally{Head.rewind();}}return{pageProps,clientState,client};};// AppWithApollo.getInitialProps = NextApp.getInitialProps\n// AppWithApollo.origGetInitialProps = NextApp.origGetInitialProps\nreturn AppWithApollo;}let browserApolloClientCache=null;function initApolloClient(options,ctx,clientState=null){if(!false){return createApolloClient(options,ctx,clientState);}if(!browserApolloClientCache){browserApolloClientCache=createApolloClient(options,ctx,clientState);}return browserApolloClientCache;}function createApolloClient(options,ctx,clientState=null){const cache=new InMemoryCache();const link=createLink(options,ctx);const client=new ApolloClient({ssrMode:!false,cache:cache.restore(clientState),link});client.toJSON=()=>null;return client;}function createLink(options,ctx){if(!false){const fetch=require('isomorphic-fetch');return new HttpLink({uri:`http://graphql-engine:8080/v1/graphql`,fetch:(url,options)=>{console.log('fetch',url,options);return fetch(url,options);}});}return createBrowserLink();}function createBrowserLink(){const httpLink=new HttpLink({credentials:'include',uri:`http://localhost:8080/v1/graphql`});const wsLink=new WebSocketLink({uri:`ws://localhost:8080/v1/graphql`,credentials:'include',options:{reconnect:true}});const terminatingLink=split(({query})=>{const{kind,operation}=getMainDefinition(query);return kind==='OperationDefinition'&&operation==='subscription';},wsLink,httpLink);return ApolloLink.from([terminatingLink]);}","map":{"version":3,"sources":["/app/services/next-js/lib/withApollo.js"],"names":["NextApp","ApolloProvider","ApolloClient","InMemoryCache","HttpLink","WebSocketLink","ApolloLink","split","getMainDefinition","Head","withApollo","App","options","AppWithApollo","client","clientState","ctx","props","initApolloClient","getInitialProps","AppTree","pageProps","res","finished","getDataFromTree","require","cache","extract","error","console","rewind","browserApolloClientCache","createApolloClient","link","createLink","ssrMode","restore","toJSON","fetch","uri","url","log","createBrowserLink","httpLink","credentials","wsLink","reconnect","terminatingLink","query","kind","operation","from"],"mappings":"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","sourcesContent":["import NextApp from \"next/app\"\r\nimport { ApolloProvider } from '@apollo/react-hooks'\r\nimport { ApolloClient } from \"apollo-client\";\r\nimport { InMemoryCache } from \"apollo-cache-inmemory\";\r\nimport { HttpLink } from \"apollo-link-http\";\r\nimport { WebSocketLink } from \"apollo-link-ws\";\r\nimport { ApolloLink, split } from \"apollo-link\";\r\nimport { getMainDefinition } from \"apollo-utilities\";\r\nimport Head from 'next/head'\r\n\r\n\r\nexport default function withApollo(App, options) {\r\n\r\n  function AppWithApollo({client, clientState, ctx, ...props}) {\r\n\r\n    if (!client) {\r\n      client = initApolloClient(options, ctx, clientState)\r\n    }\r\n\r\n    return <ApolloProvider client={ client }>\r\n      <App { ...props }/>\r\n    </ApolloProvider>\r\n  }\r\n\r\n\r\n  AppWithApollo.getInitialProps = async function ({AppTree, ctx}) {\r\n    let pageProps = {}\r\n    let clientState = {}\r\n    let client = null\r\n\r\n    if (!process.browser) {\r\n      // When redirecting, the response is finished.\r\n      if (ctx.res && ctx.res.finished) {\r\n        return {pageProps}\r\n      }\r\n\r\n      const {getDataFromTree} = require('@apollo/react-ssr')\r\n      client = initApolloClient(options, ctx)\r\n\r\n      try {\r\n        await getDataFromTree(<AppTree  { ...{pageProps, client, ctx} }/>)\r\n        clientState = client.cache.extract()\r\n      } catch (error) {\r\n        console.error(error)\r\n      } finally {\r\n        Head.rewind()\r\n      }\r\n\r\n    }\r\n\r\n    return {pageProps, clientState, client}\r\n  }\r\n\r\n\r\n  // AppWithApollo.getInitialProps = NextApp.getInitialProps\r\n  // AppWithApollo.origGetInitialProps = NextApp.origGetInitialProps\r\n\r\n  return AppWithApollo\r\n\r\n}\r\n\r\n\r\nlet browserApolloClientCache = null\r\n\r\n\r\nfunction initApolloClient(options, ctx, clientState = null) {\r\n  if (!process.browser) {\r\n    return createApolloClient(options, ctx, clientState)\r\n  }\r\n\r\n  if (!browserApolloClientCache) {\r\n    browserApolloClientCache = createApolloClient(options, ctx, clientState)\r\n  }\r\n  return browserApolloClientCache\r\n}\r\n\r\n\r\nfunction createApolloClient(options, ctx, clientState = null) {\r\n  const cache = new InMemoryCache()\r\n  const link = createLink(options, ctx)\r\n\r\n  const client = new ApolloClient({\r\n    ssrMode: !process.browser,\r\n    cache: cache.restore(clientState),\r\n    link\r\n  })\r\n\r\n  client.toJSON = () => null\r\n  return client\r\n}\r\n\r\n\r\nfunction createLink(options, ctx) {\r\n  if (!process.browser) {\r\n    const fetch = require('isomorphic-fetch')\r\n\r\n    return new HttpLink({\r\n      uri: `http://graphql-engine:8080/v1/graphql`,\r\n      fetch: (url, options) => {\r\n        console.log('fetch', url, options)\r\n        return fetch(url, options)\r\n      }\r\n    })\r\n  }\r\n\r\n  return createBrowserLink()\r\n}\r\n\r\n\r\nfunction createBrowserLink() {\r\n  const httpLink = new HttpLink({\r\n    credentials: 'include',\r\n    uri: `http://localhost:8080/v1/graphql`,\r\n  })\r\n\r\n  const wsLink = new WebSocketLink({\r\n    uri: `ws://localhost:8080/v1/graphql`,\r\n    credentials: 'include',\r\n    options: {\r\n      reconnect: true,\r\n    },\r\n  })\r\n\r\n  const terminatingLink = split(({query}) => {\r\n    const {kind, operation} = getMainDefinition(query);\r\n    return (\r\n      kind === 'OperationDefinition' && operation === 'subscription'\r\n    );\r\n  }, wsLink, httpLink)\r\n\r\n  return ApolloLink.from([terminatingLink])\r\n}\r\n\r\n\r\n"]},"metadata":{},"sourceType":"module"}